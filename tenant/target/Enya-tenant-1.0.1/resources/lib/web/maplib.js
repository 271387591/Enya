var BMapLib=window.BMapLib=BMapLib||{};var BMAP_DRAWING_MARKER="marker",BMAP_DRAWING_POLYLINE="polyline",BMAP_DRAWING_CIRCLE="circle",BMAP_DRAWING_RECTANGLE="rectangle",BMAP_DRAWING_POLYGON="polygon";(function(){var g=g||{guid:"$BAIDU$"};(function(){window[g.guid]={};g.extend=function(a,c){for(var b in c){if(c.hasOwnProperty(b)){a[b]=c[b];}}return a;};g.lang=g.lang||{};g.lang.guid=function(){return"TANGRAM__"+(window[g.guid]._counter++).toString(36);};window[g.guid]._counter=window[g.guid]._counter||1;window[g.guid]._instances=window[g.guid]._instances||{};g.lang.Class=function(a){this.guid=a||g.lang.guid();window[g.guid]._instances[this.guid]=this;};window[g.guid]._instances=window[g.guid]._instances||{};g.lang.isString=function(a){return"[object String]"==Object.prototype.toString.call(a);};g.lang.isFunction=function(a){return"[object Function]"==Object.prototype.toString.call(a);};g.lang.Class.prototype.toString=function(){return"[object "+(this._className||"Object")+"]";};g.lang.Class.prototype.dispose=function(){delete window[g.guid]._instances[this.guid];for(var a in this){if(!g.lang.isFunction(this[a])){delete this[a];}}this.disposed=true;};g.lang.Event=function(b,a){this.type=b;this.returnValue=true;this.target=a||null;this.currentTarget=null;};g.lang.Class.prototype.addEventListener=function(b,c,d){if(!g.lang.isFunction(c)){return;}!this.__listeners&&(this.__listeners={});var e=this.__listeners,a;if(typeof d=="string"&&d){if(/[^\w\-]/.test(d)){throw ("nonstandard key:"+d);}else{c.hashCode=d;a=d;}}b.indexOf("on")!=0&&(b="on"+b);typeof e[b]!="object"&&(e[b]={});a=a||g.lang.guid();c.hashCode=a;e[b][a]=c;};g.lang.Class.prototype.removeEventListener=function(a,b){if(g.lang.isFunction(b)){b=b.hashCode;}else{if(!g.lang.isString(b)){return;}}!this.__listeners&&(this.__listeners={});a.indexOf("on")!=0&&(a="on"+a);var c=this.__listeners;if(!c[a]){return;}c[a][b]&&delete c[a][b];};g.lang.Class.prototype.dispatchEvent=function(b,e){if(g.lang.isString(b)){b=new g.lang.Event(b);}!this.__listeners&&(this.__listeners={});e=e||{};for(var c in e){b[c]=e[c];}var c,d=this.__listeners,a=b.type;b.target=b.target||this;b.currentTarget=this;a.indexOf("on")!=0&&(a="on"+a);g.lang.isFunction(this[a])&&this[a].apply(this,arguments);if(typeof d[a]=="object"){for(c in d[a]){d[a][c].apply(this,arguments);}}return b.returnValue;};g.lang.inherits=function(a,c,d){var e,b,n=a.prototype,f=new Function();f.prototype=c.prototype;b=a.prototype=new f();for(e in n){b[e]=n[e];}a.prototype.constructor=a;a.superClass=c.prototype;if("string"==typeof d){b._className=d;}};g.dom=g.dom||{};g._g=g.dom._g=function(a){if(g.lang.isString(a)){return document.getElementById(a);}return a;};g.g=g.dom.g=function(a){if("string"==typeof a||a instanceof String){return document.getElementById(a);}else{if(a&&a.nodeName&&(a.nodeType==1||a.nodeType==9)){return a;}}return null;};g.insertHTML=g.dom.insertHTML=function(b,e,c){b=g.dom.g(b);var d,a;if(b.insertAdjacentHTML){b.insertAdjacentHTML(e,c);}else{d=b.ownerDocument.createRange();e=e.toUpperCase();if(e=="AFTERBEGIN"||e=="BEFOREEND"){d.selectNodeContents(b);d.collapse(e=="AFTERBEGIN");}else{a=e=="BEFOREBEGIN";d[a?"setStartBefore":"setEndAfter"](b);d.collapse(a);}d.insertNode(d.createContextualFragment(c));}return b;};g.ac=g.dom.addClass=function(p,f){p=g.dom.g(p);var d=f.split(/\s+/),e=p.className,a=" "+e+" ",b=0,c=d.length;for(;b<c;b++){if(a.indexOf(" "+d[b]+" ")<0){e+=(e?" ":"")+d[b];}}p.className=e;return p;};g.event=g.event||{};g.event._listeners=g.event._listeners||[];g.on=g.event.on=function(f,c,a){c=c.replace(/^on/i,"");f=g._g(f);var b=function(m){a.call(f,m);},o=g.event._listeners,d=g.event._eventFilter,p,e=c;c=c.toLowerCase();if(d&&d[c]){p=d[c](f,c,b);e=p.type;b=p.listener;}if(f.addEventListener){f.addEventListener(e,b,false);}else{if(f.attachEvent){f.attachEvent("on"+e,b);}}o[o.length]=[f,c,a,b,e];return f;};g.un=g.event.un=function(p,d,q){p=g._g(p);d=d.replace(/^on/i,"").toLowerCase();var a=g.event._listeners,f=a.length,e=!q,b,c,r;while(f--){b=a[f];if(b[1]===d&&b[0]===p&&(e||b[2]===q)){c=b[4];r=b[3];if(p.removeEventListener){p.removeEventListener(c,r,false);}else{if(p.detachEvent){p.detachEvent("on"+c,r);}}a.splice(f,1);}}return p;};g.getEvent=g.event.getEvent=function(a){return window.event||a;};g.getTarget=g.event.getTarget=function(a){var a=g.getEvent(a);return a.target||a.srcElement;};g.preventDefault=g.event.preventDefault=function(a){var a=g.getEvent(a);if(a.preventDefault){a.preventDefault();}else{a.returnValue=false;}};g.stopBubble=g.event.stopBubble=function(a){a=g.getEvent(a);a.stopPropagation?a.stopPropagation():a.cancelBubble=true;};g.browser=g.browser||{};if(/msie (\d+\.\d)/i.test(navigator.userAgent)){g.browser.ie=g.ie=document.documentMode||+RegExp["\x241"];}})();var k=BMapLib.DrawingManager=function(a,b){if(!a){return;}l.push(this);b=b||{};this._initialize(a,b);};g.lang.inherits(k,g.lang.Class,"DrawingManager");k.prototype.open=function(){if(this._isOpen==true){return true;}i(this);this._open();};k.prototype.close=function(){if(this._isOpen==false){return true;}var a=this;this._close();setTimeout(function(){a._map.enableDoubleClickZoom();},2000);};k.prototype.setDrawingMode=function(a){if(this._drawingType!=a){i(this);this._setDrawingMode(a);}};k.prototype.getDrawingMode=function(){return this._drawingType;};k.prototype.enableCalculate=function(){this._enableCalculate=true;this._addGeoUtilsLibrary();};k.prototype.disableCalculate=function(){this._enableCalculate=false;};k.prototype._initialize=function(b,c){this._map=b;this._opts=c;this._drawingType=c.drawingMode||BMAP_DRAWING_MARKER;if(c.enableDrawingTool){var a=new h(this,c.drawingToolOptions);this._drawingTool=a;b.addControl(a);}if(c.enableCalculate===true){this.enableCalculate();}else{this.disableCalculate();}this._isOpen=!!(c.isOpen===true);if(this._isOpen){this._open();}this.markerOptions=c.markerOptions||{};this.circleOptions=c.circleOptions||{};this.polylineOptions=c.polylineOptions||{};this.polygonOptions=c.polygonOptions||{};this.rectangleOptions=c.rectangleOptions||{};this.controlButton=c.controlButton=="right"?"right":"left";},k.prototype._open=function(){this._isOpen=true;if(!this._mask){this._mask=new j();}this._map.addOverlay(this._mask);this._setDrawingMode(this._drawingType);};k.prototype._setDrawingMode=function(a){this._drawingType=a;if(this._isOpen){this._mask.__listeners={};switch(a){case BMAP_DRAWING_MARKER:this._bindMarker();break;case BMAP_DRAWING_CIRCLE:this._bindCircle();break;case BMAP_DRAWING_POLYLINE:case BMAP_DRAWING_POLYGON:this._bindPolylineOrPolygon();break;case BMAP_DRAWING_RECTANGLE:this._bindRectangle();break;}}if(this._drawingTool&&this._isOpen){this._drawingTool.setStyleByDrawingMode(a);}};k.prototype._close=function(){this._isOpen=false;if(this._mask){this._map.removeOverlay(this._mask);}if(this._drawingTool){this._drawingTool.setStyleByDrawingMode("hander");}};k.prototype._bindMarker=function(){var b=this,a=this._map,c=this._mask;var d=function(e){var f=new BMap.Marker(e.point,b.markerOptions);a.addOverlay(f);b._dispatchOverlayComplete(f);};c.addEventListener("click",d);};k.prototype._bindCircle=function(){var c=this,q=this._map,a=this._mask,p=null,e=null;var f=function(m){if(c.controlButton=="right"&&(m.button==1||m.button==0)){return;}e=m.point;p=new BMap.Circle(e,0,c.circleOptions);q.addOverlay(p);a.enableEdgeMove();a.addEventListener("mousemove",b);g.on(document,"mouseup",d);};var b=function(m){p.setRadius(c._map.getDistance(e,m.point));};var d=function(m){var n=c._calculate(p,m.point);c._dispatchOverlayComplete(p,n);e=null;a.disableEdgeMove();a.removeEventListener("mousemove",b);g.un(document,"mouseup",d);};var r=function(m){g.preventDefault(m);g.stopBubble(m);if(c.controlButton=="right"&&m.button==1){return;}if(e==null){f(m);}};a.addEventListener("mousedown",r);};k.prototype._bindPolylineOrPolygon=function(){var c=this,a=this._map,f=this._mask,d=[],p=null;overlay=null,isBinded=false;var b=function(m){if(c.controlButton=="right"&&(m.button==1||m.button==0)){return;}d.push(m.point);p=d.concat(d[d.length-1]);if(d.length==1){if(c._drawingType==BMAP_DRAWING_POLYLINE){overlay=new BMap.Polyline(p,c.polylineOptions);}else{if(c._drawingType==BMAP_DRAWING_POLYGON){overlay=new BMap.Polygon(p,c.polygonOptions);}}a.addOverlay(overlay);}else{overlay.setPath(p);}if(!isBinded){isBinded=true;f.enableEdgeMove();f.addEventListener("mousemove",e);f.addEventListener("dblclick",o);}};var e=function(m){overlay.setPositionAt(p.length-1,m.point);};var o=function(m){g.stopBubble(m);isBinded=false;f.disableEdgeMove();f.removeEventListener("mousedown",b);f.removeEventListener("mousemove",e);f.removeEventListener("dblclick",o);if(c.controlButton=="right"){d.push(m.point);}else{if(g.ie<=8){}else{d.pop();}}overlay.setPath(d);var n=c._calculate(overlay,d.pop());c._dispatchOverlayComplete(overlay,n);d.length=0;p.length=0;c.close();};f.addEventListener("mousedown",b);f.addEventListener("dblclick",function(m){g.stopBubble(m);});};k.prototype._bindRectangle=function(){var c=this,p=this._map,f=this._mask,e=null,d=null;var a=function(m){g.stopBubble(m);g.preventDefault(m);if(c.controlButton=="right"&&(m.button==1||m.button==0)){return;}d=m.point;var n=d;e=new BMap.Polygon(c._getRectanglePoint(d,n),c.rectangleOptions);p.addOverlay(e);f.enableEdgeMove();f.addEventListener("mousemove",b);g.on(document,"mouseup",o);};var b=function(m){e.setPath(c._getRectanglePoint(d,m.point));};var o=function(m){var n=c._calculate(e,e.getPath()[2]);c._dispatchOverlayComplete(e,n);d=null;f.disableEdgeMove();f.removeEventListener("mousemove",b);g.un(document,"mouseup",o);};f.addEventListener("mousedown",a);};k.prototype._calculate=function(b,c){var d={data:0,label:null};if(this._enableCalculate&&BMapLib.GeoUtils){var a=b.toString();switch(a){case"[object Polyline]":d.data=BMapLib.GeoUtils.getPolylineDistance(b);break;case"[object Polygon]":d.data=BMapLib.GeoUtils.getPolygonArea(b);break;case"[object Circle]":var e=b.getRadius();d.data=Math.PI*e*e;break;}if(!d.data||d.data<0){d.data=0;}else{d.data=d.data.toFixed(2);}d.label=this._addLabel(c,d.data);}return d;};k.prototype._addGeoUtilsLibrary=function(){if(!BMapLib.GeoUtils){var a=document.createElement("script");a.setAttribute("type","text/javascript");a.setAttribute("src","http://api.map.baidu.com/library/GeoUtils/1.2/src/GeoUtils_min.js");document.body.appendChild(a);}};k.prototype._addLabel=function(c,a){var b=new BMap.Label(a,{position:c});this._map.addOverlay(b);return b;};k.prototype._getRectanglePoint=function(a,b){return[new BMap.Point(a.lng,a.lat),new BMap.Point(b.lng,a.lat),new BMap.Point(b.lng,b.lat),new BMap.Point(a.lng,b.lat)];};k.prototype._dispatchOverlayComplete=function(b,a){var c={overlay:b,drawingMode:this._drawingType};if(a){c.calculate=a.data||null;c.label=a.label||null;}this.dispatchEvent(this._drawingType+"complete",b);this.dispatchEvent("overlaycomplete",c);};function j(){this._enableEdgeMove=false;}j.prototype=new BMap.Overlay();j.prototype.dispatchEvent=g.lang.Class.prototype.dispatchEvent;j.prototype.addEventListener=g.lang.Class.prototype.addEventListener;j.prototype.removeEventListener=g.lang.Class.prototype.removeEventListener;j.prototype.initialize=function(b){var c=this;this._map=b;var a=this.container=document.createElement("div");var d=this._map.getSize();a.style.cssText="position:absolute;background:url(about:blank);cursor:crosshair;width:"+d.width+"px;height:"+d.height+"px";this._map.addEventListener("resize",function(e){c._adjustSize(e.size);});this._map.getPanes().floatPane.appendChild(a);this._bind();return a;};j.prototype.draw=function(){var a=this._map,c=a.pixelToPoint(new BMap.Pixel(0,0)),b=a.pointToOverlayPixel(c);this.container.style.left=b.x+"px";this.container.style.top=b.y+"px";};j.prototype.enableEdgeMove=function(){this._enableEdgeMove=true;};j.prototype.disableEdgeMove=function(){clearInterval(this._edgeMoveTimer);this._enableEdgeMove=false;};j.prototype._bind=function(){var d=this,r=this._map,q=this.container,c=null,b=null;var e=function(m){return{x:m.clientX,y:m.clientY};};var f=function(n){var o=n.type;n=g.getEvent(n);point=d.getDrawPoint(n);var m=function(s){n.point=point;d.dispatchEvent(n);};if(o=="mousedown"){c=e(n);}var t=e(n);if(o=="click"){if(Math.abs(t.x-c.x)<5&&Math.abs(t.y-c.y)<5){if(!b||!(Math.abs(t.x-b.x)<5&&Math.abs(t.y-b.y)<5)){m("click");b=e(n);}else{b=null;}}}else{m(o);}};var a=["click","mousedown","mousemove","mouseup","dblclick"],p=a.length;while(p--){g.on(q,a[p],f);}g.on(q,"mousemove",function(m){if(d._enableEdgeMove){d.mousemoveAction(m);}});};j.prototype.mousemoveAction=function(c){function t(m){var n=m.clientX,o=m.clientY;if(m.changedTouches){n=m.changedTouches[0].clientX;o=m.changedTouches[0].clientY;}return new BMap.Pixel(n,o);}var s=this._map,b=this,r=s.pointToPixel(this.getDrawPoint(c)),f=t(c),e=f.x-r.x,q=f.y-r.y;r=new BMap.Pixel((f.x-e),(f.y-q));this._draggingMovePixel=r;var a=s.pixelToPoint(r),d={pixel:r,point:a};this._panByX=this._panByY=0;if(r.x<=20||r.x>=s.width-20||r.y<=50||r.y>=s.height-10){if(r.x<=20){this._panByX=8;}else{if(r.x>=s.width-20){this._panByX=-8;}}if(r.y<=50){this._panByY=8;}else{if(r.y>=s.height-10){this._panByY=-8;}}if(!this._edgeMoveTimer){this._edgeMoveTimer=setInterval(function(){s.panBy(b._panByX,b._panByY,{noAnimation:true});},30);}}else{if(this._edgeMoveTimer){clearInterval(this._edgeMoveTimer);this._edgeMoveTimer=null;}}};j.prototype._adjustSize=function(a){this.container.style.width=a.width+"px";this.container.style.height=a.height+"px";};j.prototype.getDrawPoint=function(b){var c=this._map,d=g.getTarget(b),f=b.offsetX||b.layerX||0,a=b.offsetY||b.layerY||0;if(d.nodeType!=1){d=d.parentNode;}while(d&&d!=c.getContainer()){if(!(d.clientWidth==0&&d.clientHeight==0&&d.offsetParent&&d.offsetParent.nodeName=="TD")){f+=d.offsetLeft||0;a+=d.offsetTop||0;}d=d.offsetParent;}var e=new BMap.Pixel(f,a);var n=c.pixelToPoint(e);return n;};function h(a,b){this.drawingManager=a;b=this.drawingToolOptions=b||{};this.defaultAnchor=BMAP_ANCHOR_TOP_LEFT;this.defaultOffset=new BMap.Size(10,10);this.defaultDrawingModes=[BMAP_DRAWING_MARKER,BMAP_DRAWING_CIRCLE,BMAP_DRAWING_POLYLINE,BMAP_DRAWING_POLYGON,BMAP_DRAWING_RECTANGLE];if(b.drawingModes){this.drawingModes=b.drawingModes;}else{this.drawingModes=this.defaultDrawingModes;}if(b.anchor){this.setAnchor(b.anchor);}if(b.offset){this.setOffset(b.offset);}}h.prototype=new BMap.Control();h.prototype.initialize=function(a){var b=this.container=document.createElement("div");b.className="BMapLib_Drawing";var c=this.panel=document.createElement("div");c.className="BMapLib_Drawing_panel";if(this.drawingToolOptions&&this.drawingToolOptions.scale){this._setScale(this.drawingToolOptions.scale);}b.appendChild(c);c.innerHTML=this._generalHtml();this._bind(c);a.getContainer().appendChild(b);return b;};h.prototype._generalHtml=function(a){var e={};e.hander="鎷栧姩鍦板浘";e[BMAP_DRAWING_MARKER]="鐢荤偣";e[BMAP_DRAWING_CIRCLE]="鐢诲渾";e[BMAP_DRAWING_POLYLINE]="鐢绘姌绾�";e[BMAP_DRAWING_POLYGON]="鐢诲杈瑰舰";e[BMAP_DRAWING_RECTANGLE]="鐢荤煩褰�";var o=function(n,m){return'<a class="'+n+'" drawingType="'+m+'" href="javascript:void(0)" title="'+e[m]+'" onfocus="this.blur()"></a>';};var c=[];c.push(o("BMapLib_box BMapLib_hander","hander"));for(var d=0,f=this.drawingModes.length;d<f;d++){var b="BMapLib_box BMapLib_"+this.drawingModes[d];if(d==f-1){b+=" BMapLib_last";}c.push(o(b,this.drawingModes[d]));}return c.join("");};h.prototype._setScale=function(b){var c=390,e=50,a=-parseInt((c-c*b)/2,10),d=-parseInt((e-e*b)/2,10);this.container.style.cssText=["-moz-transform: scale("+b+");","-o-transform: scale("+b+");","-webkit-transform: scale("+b+");","transform: scale("+b+");","margin-left:"+a+"px;","margin-top:"+d+"px;","*margin-left:0px;","*margin-top:0px;","margin-left:0px\\0;","margin-top:0px\\0;","filter: progid:DXImageTransform.Microsoft.Matrix(","M11="+b+",","M12=0,","M21=0,","M22="+b+",","SizingMethod='auto expand');"].join("");};h.prototype._bind=function(b){var a=this;g.on(this.panel,"click",function(c){var d=g.getTarget(c);var e=d.getAttribute("drawingType");a.setStyleByDrawingMode(e);a._bindEventByDraingMode(e);});};h.prototype.setStyleByDrawingMode=function(e){if(!e){return;}var d=this.panel.getElementsByTagName("a");for(var c=0,f=d.length;c<f;c++){var a=d[c];if(a.getAttribute("drawingType")==e){var b="BMapLib_box BMapLib_"+e+"_hover";if(c==f-1){b+=" BMapLib_last";}a.className=b;}else{a.className=a.className.replace(/_hover/,"");}}};h.prototype._bindEventByDraingMode=function(c){var a=this;var b=this.drawingManager;if(c=="hander"){b.close();b._map.enableDoubleClickZoom();}else{b.setDrawingMode(c);b.open();b._map.disableDoubleClickZoom();}};var l=[];function i(b){var a=l.length;while(a--){if(l[a]!=b){l[a].close();}}}})();